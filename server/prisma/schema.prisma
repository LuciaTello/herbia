// Prisma Schema: like your @Entity classes in JPA/Hibernate
// Each "model" becomes a table in PostgreSQL AND a TypeScript type

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Like @Entity User in JPA
// In Spring Security, this is often called "AppUser" to avoid conflicts
model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique                        // Like @Column(unique = true)
  passwordHash String   @map("password_hash")          // NEVER store plain passwords!
  lang         String   @default("es")                  // "es" | "fr"
  missionTipCount Int @default(0) @map("mission_tip_count")
  createdAt    DateTime @default(now())

  // One-to-many: a user has many missions
  // Like @OneToMany(mappedBy = "user") List<Mission> missions;
  missions     Mission[]

  @@map("users")
}

// A mission represents a search (origin â†’ destination) with its suggested plants
// Like @Entity Mission in JPA
model Mission {
  id          Int              @id @default(autoincrement())
  origin      String
  destination String
  description String           @default("")  // General vegetation overview for this route/month
  month       Int              // 1-12, for seasonal plant suggestions
  year        Int              // e.g. 2026
  createdAt   DateTime         @default(now())
  country     String?
  countryCode String?          @map("country_code")
  region      String?
  regionCode  String?          @map("region_code")
  originLat   Float?           @map("origin_lat")
  originLng   Float?           @map("origin_lng")
  destLat     Float?           @map("dest_lat")
  destLng     Float?           @map("dest_lng")
  status      String           @default("active")  // "active" | "completed"

  // Foreign key to User
  userId      Int              @map("user_id")
  user        User             @relation(fields: [userId], references: [id])

  // One-to-many: a mission has many suggested plants
  // cascade delete handled by Prisma (onDelete: Cascade)
  plants      SuggestedPlant[] @relation("missionPlants")

  // Plants that were originally found in this mission (reverse of foundInMission)
  plantsFoundHere SuggestedPlant[] @relation("foundInMission")

  @@map("treks")
}

// A plant suggested by the AI for a specific mission
// Like @Entity SuggestedPlant in JPA
model SuggestedPlant {
  id             Int       @id @default(autoincrement())
  commonName     String
  scientificName String
  description    String
  hint           String    @default("")
  rarity         String    @default("common")
  source         String    @default("ai")   // "ai" | "user"
  found          Boolean   @default(false)
  foundAt        DateTime?

  // Mission where this plant was originally found (null if not found yet)
  foundInMissionId  Int?      @map("found_in_trek_id")
  foundInMission    Mission?  @relation("foundInMission", fields: [foundInMissionId], references: [id], onDelete: SetNull)

  // One-to-many: a plant has many photos (normalized from old imageUrls column)
  photos         PlantPhoto[]

  // Foreign key to Mission (like @ManyToOne @JoinColumn(name = "trek_id") Mission mission;)
  missionId      Int       @map("trek_id")
  mission        Mission   @relation("missionPlants", fields: [missionId], references: [id], onDelete: Cascade)

  @@map("suggested_plants")
}

// A photo for a plant, fetched from Wikipedia or iNaturalist
model PlantPhoto {
  id       Int    @id @default(autoincrement())
  url      String
  source   String   // "wikipedia" | "inaturalist"
  plantId  Int    @map("plant_id")
  plant    SuggestedPlant @relation(fields: [plantId], references: [id], onDelete: Cascade)

  @@map("plant_photos")
}

// Daily usage counter for Google Maps API calls (free tier = $200/month)
model DailyQuota {
  date  DateTime @id @db.Date
  count Int      @default(0)

  @@map("daily_quota")
}
