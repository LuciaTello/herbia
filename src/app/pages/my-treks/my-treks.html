<a routerLink="/" class="back-link">{{ i18n.t().myTreks.back }}</a>

<h2>{{ i18n.t().myTreks.title }}</h2>

@if (loading()) {
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <p class="loading-message">{{ i18n.t().myTreks.loading }}</p>
  </div>
} @else if (treks().length === 0) {
  <div class="empty">
    <p>{{ i18n.t().myTreks.emptyLine1 }}</p>
    <p>{{ i18n.t().myTreks.emptyLine2 }}</p>
  </div>
} @else {
  <div class="treks-list">
    @for (trek of treks(); track trek.id) {
      <section class="trek-card" [class.expanded]="expandedId() === trek.id">
        <div class="trek-header">
          <div class="trek-route" (click)="toggle(trek.id)">
            <span class="chevron">{{ expandedId() === trek.id ? '▾' : '▸' }}</span>
            <div>
              <h3>{{ trek.origin }} → {{ trek.destination }}</h3>
              <p class="trek-date">{{ trek.createdAt | date }}</p>
            </div>
          </div>
          <button class="delete-button" (click)="deleteTrek(trek.id)">&times;</button>
        </div>

        <p class="trek-summary">
          {{ i18n.t().myTreks.summary(trek.plants.length, foundCount(trek.plants)) }}
        </p>

        @if (expandedId() === trek.id) {
          @if (trek.description) {
            <p class="trek-description">{{ trek.description }}</p>
          }

          <div class="trek-plants">
            @for (plant of trek.plants; track plant.id) {
              <article class="plant-card" [class.found]="plant.found">
                <div class="plant-thumbnail" (click)="openGallery(refPhotos(plant.photos), plant.commonName)">
                  @if (refPhotos(plant.photos).length) {
                    <img [src]="refPhotos(plant.photos)[0].url" [alt]="plant.commonName" />
                  } @else {
                    <div class="no-photo">?</div>
                  }
                </div>
                <div class="plant-info">
                  <h4>{{ plant.commonName }}</h4>
                  <p class="scientific">{{ plant.scientificName }}</p>
                  <p class="chance" [style.color]="rarity(plant.rarity).color">
                    {{ rarity(plant.rarity).label }}
                  </p>
                  <p class="description">{{ plant.description }}</p>
                  @if (plant.found) {
                    <span class="found-badge">{{ i18n.t().myTreks.found }}</span>
                    @if (userPhotos(plant.photos).length) {
                      <div class="user-photos-box">
                        @for (photo of userPhotos(plant.photos); track photo.id) {
                          <div class="user-photo-wrapper">
                            <img class="user-photo-thumb" [src]="photo.url" [alt]="plant.commonName"
                                 (click)="openGallery(userPhotos(plant.photos), plant.commonName)" />
                            <button class="photo-delete-btn" (click)="deletePhoto(photo.id!)">&times;</button>
                          </div>
                        }
                        @if (uploadingPhotoId() === plant.id) {
                          <span class="uploading-badge">{{ i18n.t().myTreks.uploading }}</span>
                        } @else if (userPhotos(plant.photos).length < 4) {
                          <label class="add-photo-button">
                            {{ i18n.t().myTreks.addPhoto }}
                            <input type="file" accept="image/*" capture="environment"
                                   (change)="onPhotoSelected($event, plant.id)" hidden />
                          </label>
                        }
                      </div>
                    } @else {
                      @if (uploadingPhotoId() === plant.id) {
                        <span class="uploading-badge">{{ i18n.t().myTreks.uploading }}</span>
                      } @else {
                        <label class="add-photo-button">
                          {{ i18n.t().myTreks.addPhoto }}
                          <input type="file" accept="image/*" capture="environment"
                                 (change)="onPhotoSelected($event, plant.id)" hidden />
                        </label>
                      }
                    }
                  } @else {
                    <button class="found-button" (click)="markFound(plant.id)">
                      {{ i18n.t().myTreks.markFound }}
                    </button>
                  }
                </div>
              </article>
            }
          </div>
        }
      </section>
    }
  </div>
}

@if (galleryImages().length) {
  <app-photo-gallery
    [images]="galleryImages()"
    [plantName]="galleryPlantName()"
    (closeGallery)="closeGallery()"
  />
}
